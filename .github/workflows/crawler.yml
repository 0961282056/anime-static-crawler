name: Scheduled Anime Crawler

on:
  # 1. å®šæ™‚è§¸ç™¼ (Cron Job)
  # æ¯å¤© UTC 17:00 åŸ·è¡Œï¼Œå³å°ç£æ™‚é–“ (UTC+8) å‡Œæ™¨ 01:00
  schedule:
    - cron: '0 17 * * *'
    
  # 2. æ‰‹å‹•è§¸ç™¼
  # å…è¨±åœ¨ GitHub Actions é é¢æ‰‹å‹•é»æ“ŠæŒ‰éˆ•åŸ·è¡Œ
  workflow_dispatch:

jobs:
  crawl-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # é‡è¦ï¼šå…è¨± Action æ¨é€ä»£ç¢¼å›å€‰åº«

    steps:
      # æ­¥é©Ÿ 1: æª¢å‡ºç¨‹å¼ç¢¼
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: è¨­ç½® Python ç’°å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # é–‹å•Ÿ pip å¿«å–ä»¥åŠ å¿«å®‰è£é€Ÿåº¦

      # æ­¥é©Ÿ 3: å®‰è£ä¾è³´
      - name: âš™ï¸ Install dependencies
        working-directory: ./å‹•ç•«è³‡è¨Šçˆ¬èŸ²
        run: |
          pip install -r requirements.txt

      # æ­¥é©Ÿ 4: åŸ·è¡Œçˆ¬èŸ² (åªçˆ¬å–è³‡æ–™ï¼Œä¸ç”Ÿæˆ HTML)
      # æ³¨æ„ï¼šé€™è£¡ä¸è¨­å®š BUILD_ONLYï¼Œæ‰€ä»¥æœƒåŸ·è¡Œçˆ¬èŸ²
      - name: ğŸ•·ï¸ Run Crawler
        working-directory: ./å‹•ç•«è³‡è¨Šçˆ¬èŸ²
        env:
          # å¼•ç”¨ GitHub Secrets ä¸­çš„è®Šæ•¸
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          # ç¢ºä¿ BUILD_ONLY ç‚º falseï¼Œé€™æ¨£æ‰æœƒåŸ·è¡Œçˆ¬èŸ²
          BUILD_ONLY: false
        run: |
          python generate_static.py

      # æ­¥é©Ÿ 5: æäº¤ä¸¦æ¨é€æ–°è³‡æ–™
      # å°‡æ–°ç”Ÿæˆçš„ JSON å’Œ Cloudinary å¿«å–æäº¤å› GitHub
      # Cloudflare Pages æœƒåµæ¸¬åˆ°é€™æ¬¡ Push ä¸¦è‡ªå‹•é–‹å§‹æ§‹å»ºç¶²ç«™
      - name: ğŸ’¾ Commit and Push new data
        run: |
          git config --global user.name 'GitHub Action Crawler'
          git config --global user.email 'action@github.com'
          
          # åŠ å…¥ JSON è³‡æ–™æª”èˆ‡å¿«å–æª”
          # æ³¨æ„ï¼šè·¯å¾‘è¦å°æ‡‰ä½ çš„å°ˆæ¡ˆçµæ§‹
          git add å‹•ç•«è³‡è¨Šçˆ¬èŸ²/dist/data/*.json
          git add å‹•ç•«è³‡è¨Šçˆ¬èŸ²/cloudinary_cache.json
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´ï¼Œæœ‰è®Šæ›´æ‰ Commit
          # [skip ci] å¯ä»¥é¿å…é€™æ¬¡ commit å†æ¬¡è§¸ç™¼ä¸å¿…è¦çš„æª¢æŸ¥ï¼Œä½† Cloudflare ä»æœƒåµæ¸¬åˆ°
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ¤– Auto-update anime data & cache [skip ci]"
            git push
            echo "âœ… Data pushed to GitHub. Cloudflare Pages should trigger build now."