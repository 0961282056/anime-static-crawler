name: Scheduled Cloudflare Pages Deployment

on:
Â  # 1. å®šæ™‚è§¸ç™¼ (Cron Job)
Â  # æ¯å¤© UTC 17:00 åŸ·è¡Œï¼Œå³å°ç£æ™‚é–“ (UTC+8) å‡Œæ™¨ 01:00ã€‚
Â  schedule:
Â  Â  - cron: '0 17 * * *'
Â  Â  
Â  # 2. æ‰‹å‹•è§¸ç™¼
Â  # å…è¨±æ‚¨éš¨æ™‚åœ¨ GitHub Actions é é¢ä¸Šé»æ“ŠæŒ‰éˆ•æ‰‹å‹•é‹è¡Œ
Â  workflow_dispatch:

jobs:
Â  build_and_deploy:
Â  Â  # ä½¿ç”¨ Cloudflare Pages æ¨è–¦çš„åŸ·è¡Œç’°å¢ƒ
Â  Â  runs-on: ubuntu-latest
Â  Â  
Â  Â  # ç’°å¢ƒè®Šæ•¸ï¼šè®“æ‚¨çš„ build.sh å’Œ Python è…³æœ¬å¯ä»¥è®€å–
Â  Â  env:
Â  Â  Â  CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
Â  Â  Â  CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
Â  Â  Â  CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
Â  Â  Â  # å…¶ä»–çˆ¬èŸ²ç™»å…¥è®Šæ•¸...
Â  Â  Â  # USERNAME_1: ${{ secrets.USERNAME_1 }}
Â  Â  Â  # PASSWORD_1: ${{ secrets.PASSWORD_1 }}


Â  Â  steps:
Â  Â  # æ­¥é©Ÿ 1: æª¢å‡ºç¨‹å¼ç¢¼
Â  Â  - name: â¬‡ï¸ Checkout Repository
Â  Â  Â  uses: actions/checkout@v4
Â  Â  Â  # ç¢ºä¿ actions/checkout å…·æœ‰æ¨é€ (push) æ¬Šé™
Â  Â  Â  with:
Â  Â  Â  Â  token: ${{ secrets.GITHUB_TOKEN }}

Â  Â  # æ­¥é©Ÿ 2: è¨­ç½® Python ç’°å¢ƒ
Â  Â  - name: ğŸ Set up Python
Â  Â  Â  uses: actions/setup-python@v5
Â  Â  Â  with:
Â  Â  Â  Â  python-version: '3.9'

Â  Â  # æ­¥é©Ÿ 3: å®‰è£ä¾è³´ä¸¦åŸ·è¡Œå»ºæ§‹ (ç”Ÿæˆæœ€æ–°çš„ JSON å’Œ HTML æª”æ¡ˆ)
Â  Â  - name: âš™ï¸ Install dependencies and Run Static Build
Â  Â  Â  run: bash build.sh
Â  Â  Â  
Â  Â  # ğŸŒŸ ä¿®æ­£å¾Œçš„æ­¥é©Ÿï¼šè³‡æ–™èˆ‡å¿«å–æŒä¹…åŒ– ğŸŒŸ
Â  Â  # å°‡æ–°ç”Ÿæˆçš„ dist/data/*ã€index.html å’Œ Cloudinary å¿«å–æäº¤å› GitHub
Â  Â  - name: ğŸ’¾ Commit and Push new data and Cache to Repository
Â  Â  Â  run: |
Â  Â  Â  Â  # è¨­å®š Git ä½¿ç”¨è€…
Â  Â  Â  Â  git config user.name github-actions
Â  Â  Â  Â  git config user.email github-actions@users.noreply.github.com
Â  Â  Â  Â  
Â  Â  Â  Â  # *** é—œéµä¿®æ­£ï¼šæª¢æŸ¥æ˜¯å¦åŒ…å« cloudinary_cache.json çš„è®Šå‹• ***
Â  Â  Â  Â  if git diff --exit-code dist/data/ dist/index.html cloudinary_cache.json; then
Â  Â  Â  Â  Â  echo "No changes found in data or cache. Skipping commit."
Â  Â  Â  Â  else
Â  Â  Â  Â  Â  # *** é—œéµä¿®æ­£ï¼šå°‡ cloudinary_cache.json åŠ å…¥æäº¤ ***
Â  Â  Â  Â  Â  git add dist/data/ dist/index.html cloudinary_cache.json
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  # [skip ci] ç¢ºä¿é€™æ¬¡æäº¤ä¸æœƒå†æ¬¡è§¸ç™¼ Actions
Â  Â  Â  Â  Â  git commit -m "chore(data): Update anime data and Cloudinary cache [skip ci]"
Â  Â  Â  Â  Â  git push
Â  Â  Â  Â  Â  echo "Successfully pushed data and cache changes."
Â  Â  Â  Â  fi
Â  Â  Â  Â  
Â  Â  # æ­¥é©Ÿ 4: éƒ¨ç½²åˆ° Cloudflare Pages (ç¶²ç«™æ›´æ–°)
Â  Â  - name: ğŸš€ Deploy to Cloudflare Pages
Â  Â  Â  uses: cloudflare/pages-action@v1
Â  Â  Â  with:
Â  Â  Â  Â  # å¿…é ˆå¾æ‚¨çš„ GitHub å°ˆæ¡ˆ Secrets å‚³éé€™ä¸‰å€‹åƒæ•¸
Â  Â  Â  Â  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
Â  Â  Â  Â  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
Â  Â  Â  Â  projectName: 'anime-static-crawler'
Â  Â  Â  Â  directory: 'dist'