name: Scheduled Cloudflare Pages Deployment

on:
  # 1. å®šæ™‚è§¸ç™¼ (Cron Job)
  # æ¯å¤© UTC 17:00 åŸ·è¡Œï¼Œå³å°ç£æ™‚é–“ (UTC+8) å‡Œæ™¨ 01:00ã€‚
  schedule:
    - cron: '0 17 * * *'
    
  # 2. æ‰‹å‹•è§¸ç™¼
  # å…è¨±æ‚¨éš¨æ™‚åœ¨ GitHub Actions é é¢ä¸Šé»æ“ŠæŒ‰éˆ•æ‰‹å‹•é‹è¡Œ
  workflow_dispatch:

jobs:
  build_and_deploy:
    # ä½¿ç”¨ Cloudflare Pages æ¨è–¦çš„åŸ·è¡Œç’°å¢ƒ
    runs-on: ubuntu-latest
    
    # ç’°å¢ƒè®Šæ•¸ï¼šè®“æ‚¨çš„ build.sh å’Œ Python è…³æœ¬å¯ä»¥è®€å–
    env:
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      # å…¶ä»–çˆ¬èŸ²ç™»å…¥è®Šæ•¸...
      # USERNAME_1: ${{ secrets.USERNAME_1 }}
      # PASSWORD_1: ${{ secrets.PASSWORD_1 }}


    steps:
    # æ­¥é©Ÿ 1: æª¢å‡ºç¨‹å¼ç¢¼
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4
      # ç¢ºä¿ actions/checkout å…·æœ‰æ¨é€ (push) æ¬Šé™
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    # æ­¥é©Ÿ 2: è¨­ç½® Python ç’°å¢ƒ
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # æ­¥é©Ÿ 3: å®‰è£ä¾è³´ä¸¦åŸ·è¡Œå»ºæ§‹ (ç”Ÿæˆæœ€æ–°çš„ JSON å’Œ HTML æª”æ¡ˆ)
    - name: âš™ï¸ Install dependencies and Run Static Build
      run: bash build.sh
      
    # ğŸŒŸ æ–°å¢æ­¥é©Ÿï¼šè³‡æ–™æŒä¹…åŒ– ğŸŒŸ
    # å°‡æ–°ç”Ÿæˆçš„ dist/data/* å’Œ index.html æäº¤å› GitHub
    - name: ğŸ’¾ Commit and Push new data to Repository
      run: |
        # è¨­å®š Git ä½¿ç”¨è€…
        git config user.name github-actions
        git config user.email github-actions@users.noreply.github.com
        
        # æª¢æŸ¥ dist/data/ å’Œ dist/index.html æ˜¯å¦æœ‰è®Šå‹• (é€™æ˜¯é—œéµ)
        if git diff --exit-code dist/data/ dist/index.html; then
          echo "No changes found in dist/data or index.html. Skipping commit."
        else
          # æäº¤è®Šå‹•
          git add dist/data/ dist/index.html
          # [skip ci] ç¢ºä¿é€™æ¬¡æäº¤ä¸æœƒå†æ¬¡è§¸ç™¼ Actionsï¼Œé€ æˆç„¡é™å¾ªç’°
          git commit -m "chore(data): Update anime data via scheduled action [skip ci]"
          git push
        fi
        
    # æ­¥é©Ÿ 4: éƒ¨ç½²åˆ° Cloudflare Pages (ç¶²ç«™æ›´æ–°)
    - name: ğŸš€ Deploy to Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        # å¿…é ˆå¾æ‚¨çš„ GitHub å°ˆæ¡ˆ Secrets å‚³éé€™ä¸‰å€‹åƒæ•¸
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: 'anime-static-crawler'
        directory: 'dist'