name: Scheduled Cloudflare Pages Deployment

on:
  # 1. å®šæ™‚è§¸ç™¼ (Cron Job)
  # æ¯å¤© UTC 17:00 åŸ·è¡Œï¼Œå³å°ç£æ™‚é–“ (UTC+8) å‡Œæ™¨ 01:00ã€‚
  schedule:
    - cron: '0 17 * * *'
    
  # 2. æ‰‹å‹•è§¸ç™¼
  # å…è¨±æ‚¨éš¨æ™‚åœ¨ GitHub Actions é é¢ä¸Šé»æ“ŠæŒ‰éˆ•æ‰‹å‹•é‹è¡Œ
  workflow_dispatch:

jobs:
  build_and_deploy:
    # ä½¿ç”¨ Cloudflare Pages æ¨è–¦çš„åŸ·è¡Œç’°å¢ƒ
    runs-on: ubuntu-latest
    
    # ç’°å¢ƒè®Šæ•¸ï¼šè®“æ‚¨çš„ build.sh å’Œ Python è…³æœ¬å¯ä»¥è®€å–
    # é€™è£¡å°‡ .env ä¸­çš„æ©Ÿå¯†è³‡è¨Šä»¥ Secrets æ–¹å¼å‚³éï¼Œéå¸¸é‡è¦ï¼
    env:
      # å¾æ‚¨çš„ .env æª”æ¡ˆä¸­å–å¾—éœ€è¦çš„æ©Ÿå¯†è®Šæ•¸ï¼Œä¸¦æ˜ å°„åˆ° Actions Secrets
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      # å¦‚æœæ‚¨çš„çˆ¬èŸ²éœ€è¦ç™»å…¥ï¼Œè«‹å°‡ USERNAME/PASSWORD ä¹ŸåŠ å…¥
      # USERNAME_1: ${{ secrets.USERNAME_1 }}
      # PASSWORD_1: ${{ secrets.PASSWORD_1 }}


    steps:
    # æ­¥é©Ÿ 1: æª¢å‡ºç¨‹å¼ç¢¼
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4

    # æ­¥é©Ÿ 2: è¨­ç½® Python ç’°å¢ƒ
    # æ ¹æ“šæ‚¨çš„ runtime.txt (python-3.9.18) è¨­å®šç‰ˆæœ¬
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9' # ä½¿ç”¨ 3.9 ç³»åˆ—ç‰ˆæœ¬ï¼Œèˆ‡ runtime.txt ä¸€è‡´

    # æ­¥é©Ÿ 3: å®‰è£ä¾è³´ä¸¦åŸ·è¡Œå»ºæ§‹
    # é€™è£¡ç›´æ¥é‹è¡Œæ‚¨çš„ build.sh è…³æœ¬ï¼Œå®ƒæœƒè™•ç† pip å‡ç´šå’Œå®‰è£ requirements.txt ä¾è³´
    - name: âš™ï¸ Install dependencies and Run Static Build
      run: bash build.sh
      
    # æ­¥é©Ÿ 4: éƒ¨ç½²åˆ° Cloudflare Pages
    # é€™æ˜¯å°‡ 'dist' è³‡æ–™å¤¾å…§å®¹ä¸Šå‚³åˆ° Cloudflare çš„é—œéµæ­¥é©Ÿ
    - name: ğŸš€ Deploy to Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        # å¿…é ˆå¾æ‚¨çš„ GitHub å°ˆæ¡ˆ Secrets å‚³éé€™ä¸‰å€‹åƒæ•¸
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: 'anime-static-crawler' # æ‚¨çš„ Cloudflare Pages å°ˆæ¡ˆåç¨±
        directory: 'dist' # å»ºæ§‹è¼¸å‡ºç›®éŒ„